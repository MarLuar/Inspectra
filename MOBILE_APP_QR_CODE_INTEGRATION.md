# Mobile App QR Code Storage Integration

## Changes Made

I've updated the QR code generator service to automatically store QR codes in Supabase when they are generated. This allows the ESP32 to fetch these QR codes during sync operations.

## Files Modified

### 1. lib/services/qr_code_generator_service.dart

**Added:**
- Supabase client initialization
- `storeQrCodeInSupabase()` method to store QR code data in the documents table
- `_storeQrCodeInSeparateTable()` fallback method for alternative storage
- Integration of QR code storage in the `generateProjectQrCode()` method

**How it works:**
1. When a project QR code is generated, the system first creates the QR code image file
2. Then it stores the QR code data string in Supabase in two possible locations:
   - Primary: Updates the `qr_code` column in the `documents` table for all documents belonging to the project
   - Fallback: Inserts into a `project_qrcodes` table if the primary method fails
3. The ESP32 can then fetch these QR codes during sync operations

## How the Integration Works

### Mobile App Side:
1. When a user creates a project, the `QrCodeGeneratorService.generateProjectQrCode()` method is called
2. This method generates the QR code image and simultaneously stores the QR code data in Supabase
3. The QR code data follows the format: `INSPROJECT:project-id|project-name`

### ESP32 Side:
1. During sync operations, the ESP32 fetches QR code data from Supabase
2. The ESP32 looks for QR codes in the `documents` table (with `qr_code` column) or in the `project_qrcodes` table
3. The ESP32 associates the QR code data with the appropriate project
4. When users click "Show QR" for a project, the ESP32 displays the QR code from Supabase

## Database Schema Requirements

For this to work properly, you need to ensure your Supabase database has the appropriate structure:

### Option 1: Add qr_code column to documents table
```sql
ALTER TABLE documents ADD COLUMN qr_code TEXT;
```

### Option 2: Create a separate project_qrcodes table
```sql
CREATE TABLE project_qrcodes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  project_name TEXT,
  qr_code_data TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Error Handling

The system includes robust error handling:
- If the primary storage method fails (due to missing column or RLS policies), it falls back to the alternative method
- All operations are logged for debugging purposes
- The system gracefully handles cases where Supabase is unavailable

## Result

After this integration:
- QR codes generated on the mobile app are automatically stored in Supabase
- The ESP32 can fetch these QR codes during sync operations
- Users can view project QR codes on the ESP32 that were originally generated on the mobile app
- The QR code data is synchronized between the mobile app and ESP32